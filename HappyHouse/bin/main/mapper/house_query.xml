<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN"    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.happyhouse.dao.HouseDao">
	<select id="houseList" parameterType="com.ssafy.happyhouse.dto.HouseParamDto" resultType="com.ssafy.happyhouse.dto.HouseDto">
	SELECT d.NO, d.APTNAME, d.CODE gugun_code, d.dong, d.DEALAMOUNT, d.BUILDYEAR, d.DEALYEAR, d.DEALMONTH, d.DEALDAY, d.AREA, d.FLOOR, d.JIBUN, d.TYPE, d.RENTMONEY, i.LAT, i.LNG, i.IMG, 
		(SELECT CASE WHEN EXISTS(
			SELECT 1 FROM USER u, BOOKMARK b WHERE u.USER_SEQ=#{userSeq} AND u.USER_SEQ=b.USER_SEQ AND d.NO=b.DEAL_NO)
        THEN true ELSE false END) BOOKMARKED
		FROM HOUSEDEAL d, HOUSEINFO i
  		WHERE d.APTNAME = i.APTNAME AND d.CODE = i.CODE AND d.DONG = i.DONG
  		ORDER BY d.NO DESC
  		LIMIT #{limit} OFFSET #{offset};
	</select>
	
	<select id="houseListTotalCount" resultType="int">
		SELECT COUNT(*) FROM HOUSEDEAL
	</select>
	
	<select id="houseSearchDong" parameterType="com.ssafy.happyhouse.dto.HouseParamDto" resultType="com.ssafy.happyhouse.dto.HouseDto">
		SELECT d.NO, d.APTNAME, d.CODE GUGUN_CODE, d.DONG, d.DEALAMOUNT, d.BUILDYEAR, d.DEALYEAR, d.DEALMONTH, d.DEALDAY, d.AREA, d.FLOOR, d.JIBUN, d.TYPE, d.RENTMONEY, i.LAT, i.LNG, i.IMG,
			  (SELECT CASE WHEN EXISTS(
				  SELECT 1 FROM USER u, BOOKMARK b WHERE u.USER_SEQ=#{userSeq} AND u.USER_SEQ=b.USER_SEQ AND d.NO=b.DEAL_NO)
			  THEN true ELSE false END) BOOKMARKED
			  FROM HOUSEDEAL d, HOUSEINFO i, (SELECT NAME AS DONG_NAME, GUGUN_CODE FROM DONG_CODE WHERE CODE=#{searchWord}) c
			  WHERE d.APTNAME = i.APTNAME AND d.CODE = i.CODE AND d.DONG = i.DONG AND d.DONG=c.DONG_NAME
			  ORDER BY d.NO DESC
		 	  LIMIT #{limit} OFFSET #{offset};
	</select>
	
	<select id="houseSearchDongTotalCount" parameterType="string" resultType="int">
		SELECT count(*)
			FROM HOUSEDEAL d, (SELECT NAME AS DONG_NAME, GUGUN_CODE FROM DONG_CODE WHERE CODE=#{searchWord}) c
			WHERE d.dong = c.dong_name
	</select>
	
	<select id="houseSearchApt" parameterType="com.ssafy.happyhouse.dto.HouseParamDto" resultType="com.ssafy.happyhouse.dto.HouseDto">
		SELECT d.NO, d.APTNAME, d.CODE gugun_code, d.dong, d.DEALAMOUNT, d.BUILDYEAR, d.DEALYEAR, d.DEALMONTH, d.DEALDAY, d.AREA, d.FLOOR, d.JIBUN, d.TYPE, d.RENTMONEY, i.LAT, i.LNG, i.IMG
		  (SELECT 1 FROM USER u, BOOKMARK b where u.USER_SEQ=#{userSeq} and u.USER_SEQ=b.USER_SEQ and d.NO=b.DEAL_NO) BOOKMARKED
		  FROM HOUSEDEAL d, HOUSEINFO i
		  WHERE d.APTNAME = i.APTNAME AND d.CODE = i.CODE AND d.DONG = i.DONG AND d.APTNAME like CONCAT('%', #{searchWord}, '%')
		  ORDER BY d.NO DESC
	 	  LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<select id="houseSearchAptTotalCount" parameterType="string" resultType="int">
		SELECT COUNT(*)
		  FROM HOUSEDEAL d
  		  WHERE d.APTNAME like CONCAT('%', #{searchWord}, '%')
	</select>
	
	<select id="sidoList" resultType="map">
		SELECT CODE AS SIDO_CODE, NAME AS SIDO_NAME
		  FROM SIDO_CODE
		  ORDER BY NAME ASC
	</select>
	
	<select id="gugunList" parameterType="string" resultType="map">
		SELECT CODE AS GUGUN_CODE, NAME AS GUGUN_NAME
		  FROM GUGUN_CODE
		  WHERE SIDO_CODE=#{sidoCode}
		  ORDER BY NAME ASC
	</select>
	
	<select id="dongList" parameterType="map" resultType="map">
		SELECT CODE AS DONG_CODE, NAME AS DONG_NAME
		  FROM DONG_CODE
		  WHERE CITY_CODE=#{sidoCode} AND GUGUN_CODE=#{gugunCode}
		  ORDER BY NAME ASC;
	</select>
	
	<insert id="insertBookmark" parameterType="map">
		INSERT INTO BOOKMARK
		  VALUES(#{userSeq}, #{dealNo})
	</insert>
	
	<delete id="deleteBookmark" parameterType="map">
		DELETE FROM BOOKMARK
		  WHERE USER_SEQ=#{userSeq} and DEAL_NO=#{dealNo}
	</delete>
</mapper>